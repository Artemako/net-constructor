# Журнал отмены (Undo/Redo)

Журнал отмены позволяет отменять и повторять изменения в UI проекта до сохранения файла. Файл проекта на диске не меняется, пока пользователь не вызовет «Сохранить» или «Сохранить как».

Реализация: [package.modules.undojournal](api/modules.md#package.modules.undojournal) — класс `UndoJournal`. Объект журнала доступен через менеджер объектов приложения (главное окно). Обработка undo/redo и запись действий — в [package.components.mainwindow](api/components.md#package.components.mainwindow).

## Типы записей и на что влияют

| Тип записи | Что откатывается / повторяется |
|------------|--------------------------------|
| **form** | Изменение одного поля формы. Контекст: вкладка и при необходимости объект (узел/соединение). Используется для: вкладка «Общие» — параметры диаграммы (`__general_diagram_parameters_widgets`); вкладка «Контрольные секторы» — параметры секторов; вкладка «Элементы» — данные и параметры выбранного узла или соединения (`__editor_object_data_widgets`, `__editor_object_parameters_widgets`, `__editor_type_object_*`, `__editor_objects_*`). В записи хранятся: `dict_name`, `key`, `widget_type`, `old_value`, `new_value`. |
| **table_cell** | Изменение ячейки таблицы контрольных секторов (название сектора, физическая длина). В записи: `table_id`, `row`, `col`, `old_value`, `new_value`. |
| **diagram_type** | Смена типа диаграммы в комбобоксе на вкладке «Общие». Откат/повтор восстанавливает выбранный тип и параметры диаграммы из данных проекта. |
| **table_row_add** / **table_row_delete** | Добавление или удаление одной строки в таблице (если используется отдельно от пары узел+соединение). |
| **table_row_reorder** | Изменение порядка строк в таблице элементов (узлы/соединения). При откате/повторе восстанавливается порядок строк. |
| **table_row_add_pair** / **table_row_delete_pair** | Атомарное добавление или удаление пары «узел + соединение» в таблице элементов. При откате добавления пара удаляется; при откате удаления пара восстанавливается в конце списков. |

Undo применяет запись: восстанавливает `old_value` (для form/table_cell) или откатывает действие (удаление добавленной пары, восстановление удалённой и т.д.). Redo повторяет запись: восстанавливает `new_value` или повторяет действие.

Контекст журнала привязан к вкладке и к выбранному объекту (для вкладки «Элементы»). Откат/повтор выполняется только если текущий контекст совпадает с контекстом записи (иначе запись пропускается при обходе стека).

## Лимит и очистка

- **Лимит записей:** настраивается в диалоге «Настройки» (группа «Журнал»). Диапазон 1–1000, по умолчанию 100. При превышении лимита самые старые записи удаляются. Хранится в [package.modules.settings](api/modules.md#package.modules.settings) (`journal_limit`).
- **Очистка:** журнал (undo и redo) очищается при сохранении проекта и при открытии/создании нового проекта.

## Ссылки на код

- `UndoJournal`, типы записей `JournalEntry`, функции `_make_form_entry`, `_make_table_cell_entry`, `_make_diagram_type_entry`, `_make_table_row_*` — [package.modules.undojournal](api/modules.md#package.modules.undojournal).
- Вызовы `record_form_change`, `record_table_cell_change`, `record_diagram_type_change`, `record_table_row_add_pair`, `record_table_row_delete_pair`, `record_table_row_reorder` и обработчики `_undo`, `_redo` — [package.components.mainwindow](api/components.md#package.components.mainwindow).
